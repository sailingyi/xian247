<html>
<head>
    <title>Text to Image Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container text-center">
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <a class="navbar-brand" href="#">Image Generator</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                <div class="navbar-nav">
                    <a class="nav-item nav-link active" href="./index">Home <span class="sr-only"></span></a>
                    <a class="nav-item nav-link" href="./test">Test</a>
                    <a class="nav-item nav-link disabled" href="#">Pricing</a>
                    <a class="nav-item nav-link disabled" href="#">Disabled</a>
                </div>
                </div>
            </nav> 
            <h1>Generate Image based on Prompt</h1>
            <p><h3>(1) Unsplash Image</h3></p>
            <p>Enter text to generate an image:</p>
            <input type="text" id="textPromptInput" class="form-control mb-3" placeholder="Enter Text Prompt">
            <button onclick="generateImage()" class="btn btn-primary">(1) Generate Image</button>
            <div id="imageContainer" class="mt-3"></div>

            <p></p><p></p><p></p>
            <p><h3>(2) Stability AI Image</h3></p>
            <p>Enter Your API Key:</p>
            <input type="text" id="textKeyInput" class="form-control mb-3" placeholder="Enter Key">
            <button onclick="generateImage2()" class="btn btn-primary">(2) Test Generate Image</button>
            <div id="imageContainer2" class="mt-3"></div>            
    </div>

    <script>
        function showAlert_key() {
            var alertText = 'Please provide your API key.';
            alert(alertText);
        }
        function showAlert_prompt(){
            var alertText = 'Please provide your image prompts.';
            alert(alertText);
        }
        function generateImage() {
            const textPrompt = document.getElementById('textPromptInput').value;
            const imageContainer = document.getElementById('imageContainer');
            //const _alertContainer = document.getElementById('alertContainer');
            if (!textPrompt) {
                showAlert_prompt();
                throw new Error('Missing Stability API key.');
                
                //_alertContainer.innerHTML = '';
                //_alertContainer.appendChild(
                //    <div class="alert alert-warning alert-dismissible fade show" role="alert">
                //    <strong>Holy guacamole!</strong> You should check in on your Image Prompt fields.
                //    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                //        <span aria-hidden="true">&times;</span>
                //    </button>
                //    </div>
                //);
            }
            // You can make an AJAX call here to fetch image based on text input
            // For demonstration purposes, let's just display a placeholder image
            const placeholderImageUrl = 'https://source.unsplash.com/featured/?' + textPrompt;
            const imageElement = document.createElement('img');
            imageElement.setAttribute('src', placeholderImageUrl);
            imageElement.setAttribute('class', 'img-fluid');
    
            imageContainer.innerHTML = '';
            imageContainer.appendChild(imageElement);
        }
    </script>

    <script>
        function generateImage2(){
            const textPrompt = document.getElementById('textPromptInput').value;
            const textKey = document.getElementById('textKeyInput').value;
            if (!textPrompt) {showAlert_prompt();throw new Error('Missing Image Prompts.');}
            if (!textKey) {showAlert_key();throw new Error('Missing Stability API key.');}



            fetch('https://api.stability.ai/v1/generation/stable-diffusion-xl-1024-v1-0/text-to-image', 
                {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Accept: 'image/png',  // application/json
                        Authorization: `Bearer ${textKey}`
                    },
                    body: JSON.stringify({
                        text_prompts: [
                            {
                                text: `${textPrompt}`,
                            },
                        ],
                        cfg_scale: 7,
                        height: 1024,
                        width: 1024,
                        steps: 30,
                        samples: 1,
                    }),
                })
                .then(response => response.blob())
                .then((blob) => {
                    const imageUrl = URL.createObjectURL(blob);
                    const imageElement = document.createElement("img");
                    imageElement.src = imageUrl;
                    const container = document.getElementById("imageContainer2");
                    container.appendChild(imageElement);
                    })
                .catch(error => {console.error('Error:', error);});
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"></script>

    <script>
        // Stability API Reference
        import fs from "node:fs";
        import axios from "axios";
        import FormData from "form-data";

        const textPrompt = document.getElementById('textPromptInput').value;
        const textKey = document.getElementById('textKeyInput').value;

        const formData = {
            image: fs.createReadStream("./husky-in-a-field.png"),
            prompt: `${textPrompt}`,
            search_prompt: "nails",
            output_format: "png"
        };

        const response = await axios.postForm(
            `https://api.stability.ai/v2beta/stable-image/edit/search-and-replace`,
            axios.toFormData(formData, new FormData()),
            {
                validateStatus: undefined,
                responseType: "arraybuffer",
                headers: { 
                Authorization: `Bearer ${textKey}`, 
                Accept: "image/*"
                },
            },
        );

        if(response.status === 200) {
            fs.writeFileSync("./generated_nails.png", Buffer.from(response.data));
            } 
        else {throw new Error(`${response.status}: ${response.data.toString()}`);}   
    </script>




</body>
</html>
