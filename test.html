<!DOCTYPE html>
<html>
<head>
    <title>Text to Image Generator</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body>
    <div class="container text-center">
            <nav class="navbar navbar-expand-lg navbar-light bg-light">
                <a class="navbar-brand" href="#">Image Generator</a>
                <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNavAltMarkup" aria-controls="navbarNavAltMarkup" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
                <div class="navbar-nav">
                    <a class="nav-item nav-link" href="./index">Home <span class="sr-only"></span></a>
                    <a class="nav-item nav-link active" href="./test">Test</a>
                    <a class="nav-item nav-link disabled" href="#">Pricing</a>
                    <a class="nav-item nav-link disabled" href="#">Disabled</a>
                </div>
                </div>
            </nav> 
            <h1>Test Uploading An Image and Generate based on Prompt</h1>
            <p><h3>(Step 1) Enter prompts to generate an image:</h3></p>
            <input type="text" id="textPromptInput" class="form-control mb-3" placeholder="Enter Text Prompt">
            <p></p><p></p><p></p>
            <p><h3>(Step 2) Enter Your API Key:</h3></p>
            <input type="text" id="textKeyInput" class="form-control mb-3" placeholder="Enter Key">
            <p><h3>(Step 3) Select Your Input Image:</h3></p>
            <div>
                <form action="https://api.stability.ai/v2beta/stable-image/edit/search-and-replace" method="post" enctype="multipart/form-data">
                <label for="file">File</label>
                <input id="imagefile" name="file" type="file" />
                <br></br>
                <input type="submit" class="btn btn-primary"  formenctype="multipart/form-data"  value="Generate!  (4 credit)" />
                </form>
            </div>
            <br></br>
            <div id="imageContainer" class="mt-3"></div>          
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script>
        //import fs from "node:fs";
        const form = document.querySelector('form');
        form.addEventListener('submit', async (event) =>{
            event.preventDefault();

            const textPrompt = document.getElementById('textPromptInput').value;
            const textKey = document.getElementById('textKeyInput').value;
            if (!textPrompt) {showAlert_prompt();throw new Error('Missing Image Prompts.');}
            if (!textKey) {showAlert_key();throw new Error('Missing Stability API key.');}

            const form = event.currentTarget;
            const url = new URL(form.action);

            const form_for_request = new FormData();

            // read imagefile as formData 
            //const formData = new FormData(form);

            // read imagefile as imagefile
            form_for_request.append("image", $("#imagefile")[0].files[0]);

            // append other parameters
            form_for_request.append("prompt", `${textPrompt}`);
            form_for_request.append("search_prompt", 'nails');
            //_payload = new FormData(form_for_request);
            console.log('form_for_request now is:', form_for_request);

            fetch(url, {
                    method: 'POST',
                    body: form_for_request,
                    validationStatus: undefined,
                    headers: {
                        //'Content-Type': 'multipart/form-data',
                        Accept: 'image/*',  // application/json
                        Authorization: `Bearer ${textKey}`
                    },
                    
                })
                .then(response => response.blob())
                .then((blob) => {
                    const imageUrl = URL.createObjectURL(blob);
                    const imageElement = document.createElement("img");
                    imageElement.src = imageUrl;
                    imageElement.class = 'img-fluid'
                    const container = document.getElementById("imageContainer");
                    container.appendChild(imageElement);
                    })
                .catch(error => {console.error('Error:', error);});
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.min.js"></script>
</body>
</html>